Branch:
    stage: build
    extends: .cache-pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/artifacts_builder:php73
    tags:
        - autoscale
    script:
        - >
            if [[ -f webpack.config.js ]] ; then
                npm run build:dev
            fi
        - >
            if [[ -f composer.json ]] ; then
                composer install --no-dev --no-scripts --verbose
            fi
        - ./.make/deploy-copy.js -t ./${CI_PROJECT_NAME}
        - ./.make/deploy-cleanup.js -t ./${CI_PROJECT_NAME}
    artifacts:
        expire_in: 1 week
        name: "${CI_PROJECT_NAME}.${CI_COMMIT_REF_SLUG}.${CI_PIPELINE_IID}"
        paths:
            - ${CI_PROJECT_NAME}
    except:
        refs:
            - master
            - develop
            - tags
            - stable
            - bleeding
