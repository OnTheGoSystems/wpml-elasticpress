.update-branch:
    stage: build
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/git:latest
    tags:
        - autoscale
    script:
        - echo "${CI_REPOSITORY_URL}"
        - git fetch --all
        - git checkout ${SOURCE_BRANCH}
        - git reset --hard origin/${CI_COMMIT_REF_NAME}
        - git remote set-url origin "git@git.onthegosystems.com:${CI_PROJECT_PATH}.git"
        - git remote -v
        - git fetch --all
        - git push --verbose -u --force-with-lease origin ${SOURCE_BRANCH}

Make-Stable:
    extends: .update-branch
    variables:
        SOURCE_BRANCH: '${OTGS_CI_PROJECT_BRANCHES_STABLE}'
    only:
        refs:
            - master

Make-Bleeding:
    extends: .update-branch
    variables:
        SOURCE_BRANCH: '${OTGS_CI_PROJECT_BRANCHES_BLEEDING}'
    only:
        refs:
            - develop

.build-branch:
    stage: build
    extends: .cache-pull
    when: on_success
    image: registry.otgs.work/infrastructure/docker-images/artifacts_builder:php73
    tags:
        - autoscale
    script:
        - >
            if [[ -f webpack.config.js ]] ; then
                npm run build:prod
            fi
        - >
            if [[ -f ./vendor/bin/otgs-wp-plugin-version ]] ; then
                PLUGIN_VERSION=$(./vendor/bin/otgs-wp-plugin-version version:get ./)-build.${CI_PIPELINE_IID}
                if [[ -f composer.json ]] ; then
                    composer install --no-dev --no-scripts --verbose
                fi
                ./.make/deploy-copy.js -t ./${CI_PROJECT_NAME}
                ./.make/deploy-update-version.js -t ./${CI_PROJECT_NAME} -r ${PLUGIN_VERSION}
                ./.make/deploy-cleanup.js -t ./${CI_PROJECT_NAME}
            fi

Bleeding:
    extends: .build-branch
    artifacts:
        expire_in: 1 week
        name: "${CI_PROJECT_NAME}.${CI_COMMIT_REF_SLUG}"
        paths:
            - ${CI_PROJECT_NAME}
    only:
        refs:
            - bleeding

Stable:
    extends: .build-branch
    artifacts:
        expire_in: 1 week
        name: "${CI_PROJECT_NAME}.${CI_COMMIT_REF_SLUG}"
        paths:
            - ${CI_PROJECT_NAME}
    only:
        refs:
            - stable
